---
title: "Concepts of Bayesian Data Analysis: Project4"
author:
  - Charles Muiruri^[Universitiet Hasselt, charles.muiruri@student.uhasselt.be]
  - Gianni Guarraci^[Universitiet Hasselt, gianni.guarraci@student.uhasselt.be]
  - Juan Vanegas Jadan^[Universitiet Hasselt, juan.vanegasjadan@student.uhasselt.be]
  - Ronald Makanga^[Universitiet Hasselt, ronald.makanga@student.uhasselt.be]
date: Report generated - `r format(Sys.time(), "%B %d, %Y")`
output: 
  pdf_document: 
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.height = 12,
  fig.width = 12
  )
```


```{r load_packages, include=FALSE}

if (!require(pacman)) install.packages("pacman")
p_load(rjags, coda, nimble, R2OpenBUGS, ggplot2, here, dplyr, ggpubr, tidyr)

```


```{r load_data, include=FALSE}
projdata <- as.data.frame(read.csv(here("data/projectdata.txt")))|>
  mutate(less_133pc = ifelse(Poverty == "<133% FPL", 1,0),
         btn133_400_pc = ifelse(Poverty == "133% to <400% FPL", 1,0),
         great_400pc = ifelse(Poverty == ">400% FPL", 1,0))
```


```{r prepDta, include=FALSE}
# Data prep for bugs
model_data <- list(
  Y = projdata$Vaccinated,
  N = projdata$Sample.Size,
  btn133_400_pc = projdata$btn133_400_pc,
  great_400pc = projdata$great_400pc,
  J = nrow(projdata)
)
```


```{r initial_values, include=FALSE}
model_inits <- list(
  list(beta0 = 0, beta1 = 0, beta2 = 0)
)

parameters <- c("beta0", "beta1", "beta2")
```


```{r define_model, include=FALSE}
model1 <- function(){
  for (i in 1:J){
    Y[i] ~ dbin(p[i], N[i])
    logit(p[i]) <- beta0 + beta1*btn133_400_pc[i] + beta2*great_400pc[i]
  }
  #priors
  beta0 ~ dnorm(0, 0.001)
  beta1 ~ dnorm(0, 0.001)
  beta2 ~ dnorm(0, 0.001)
}

# Write model to file
write.model(model1, here("models/model1code.txt"))
# View file
# file.show(here("models/model1code.txt"))
```

\newpage 
# Modeling using Open Bugs

## Model

```{r model}
model.out <- bugs(model_data, model_inits, 
                  parameters = parameters, model.file = here("models/model1code.txt"),
                  n.chains = 1, n.iter = 10000, n.burnin = 5000, codaPkg = TRUE, debug = FALSE)

# debug=TRUE opens openBug and displays traceplots and summaries

out <- read.bugs(model.out)
summary(out)
HPDinterval(out, prob = 0.95)
# plot(out)
# 
# summary(out)[[1]]["beta1","Mean"]
```

## Density plots

```{r density_plots}
# Prep data for density and trace plots
mcmc_samples <- as.mcmc(out)
mcmc_df <- as.data.frame(mcmc_samples)
mcmc_df$iteration <- 1:nrow(mcmc_df)
mcmc_long <- pivot_longer(mcmc_df, cols = -iteration, names_to = "Parameter", values_to = "Value")

hpd <- HPDinterval(out, prob = 0.95)
hpd[[1]]["beta1", "lower"]

points_data <- data.frame(x = mcmc_df$beta0, x1 = mcmc_df$beta1,x2 = mcmc_df$beta2,
                          x3 = mcmc_df$deviance,y = rep(0, nrow(mcmc_df)))

ggarrange(p_beta0 <- ggplot(mcmc_df, aes(x = beta0)) +
  geom_density(fill = "blue", alpha = 0.1) +
  geom_point(data = points_data, aes(x = x, y = y)) +
  labs(title = "Posterior Distribution of beta0", x = "beta0", y = "Density")+
  geom_vline(aes(xintercept = hpd[[1]]["beta0", "lower"]), linetype = "dashed", color = "red") +
  geom_vline(aes(xintercept = hpd[[1]]["beta0", "upper"]), linetype = "dashed", color = "red") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),

p_beta1 <- ggplot(mcmc_df, aes(x = beta1)) +
  geom_density(fill = "green", alpha = 0.1) +
  geom_point(data = points_data, aes(x = x1, y = y)) +
  labs(title = "Posterior Distribution of beta1", x = "beta1", y = "Density") +
  geom_vline(aes(xintercept = hpd[[1]]["beta1", "lower"]), linetype = "dashed", color = "red") +
  geom_vline(aes(xintercept = hpd[[1]]["beta1", "upper"]), linetype = "dashed", color = "red") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),

p_beta2 <- ggplot(mcmc_df, aes(x = beta2)) +
  geom_density(fill = "red", alpha = 0.1) +
  geom_point(data = points_data, aes(x = x2, y = y)) +
  labs(title = "Posterior Distribution of beta2", x = "beta2", y = "Density")+
  geom_vline(aes(xintercept = hpd[[1]]["beta2", "lower"]), linetype = "dashed", color = "red") +
  geom_vline(aes(xintercept = hpd[[1]]["beta2", "upper"]), linetype = "dashed", color = "red") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),

p_dev <- ggplot(mcmc_df, aes(x = deviance)) +
  geom_density(fill = "yellow", alpha = 0.1) +
  geom_point(data = points_data, aes(x = x3, y = y)) +
  labs(title = "Posterior Distribution of deviance", x = "Deviance", y = "Density")+
  geom_vline(aes(xintercept = hpd[[1]]["deviance", "lower"]), linetype = "dashed", color = "red") +
  geom_vline(aes(xintercept = hpd[[1]]["deviance", "upper"]), linetype = "dashed", color = "red") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()), nrow = 2, ncol = 2)
```

### Summary of posterior distribution

  - The Posterior of **$\beta_0$** has a mean of **`r summary(out)[[1]]["beta0","Mean"]`** which is the central tendency of the intercept term,  with a 95% credible HPD interval of **(`r hpd[[1]]["beta0", "lower"]`, `r hpd[[1]]["beta0", "upper"]`)** in which the intercept term lies with 95% probability.
  - The Posterior of **$\beta_1$** has a mean of **`r summary(out)[[1]]["beta1","Mean"]`** which is the central tendency of the Poverty = `133% to <400% FPL` term, with a 95% HPD interval of **(`r hpd[[1]]["beta1", "lower"]`, `r hpd[[1]]["beta1", "upper"]`)** in which this Poverty term lies with 95% probability.
  - The Posterior of **$\beta_2$** has a mean of **`r summary(out)[[1]]["beta2","Mean"]`** which is the central tendency of the Poverty = `>400% FPL` term, with a 95% HPD interval of **(`r hpd[[1]]["beta2", "lower"]`, `r hpd[[1]]["beta2", "upper"]`)** in which this Poverty term lies with 95% probability.
  - The Posterior of the **Deviance** has a mean of **`r summary(out)[[1]]["deviance","Mean"]`** which is the central tendency of the Deviance, with a 95% HPD interval of **(`r hpd[[1]]["deviance", "lower"]`, `r hpd[[1]]["deviance", "upper"]`)**.


## Trace Plots

```{r trace_plots}
ggplot(mcmc_long|>filter(iteration > 4800), aes(x = iteration, y = Value, color = Parameter)) +
  geom_line() +
  scale_color_manual(values = c("blue", "green", "red", "yellow")) +
  facet_wrap(~ Parameter, scales = "free_y") +
  labs(title = "Trace Plots of MCMC Samples", x = "Iteration", y = "Parameter Value") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none")
```

## Correlation plot

```{r correlation_plot, fig.height=6, fig.width=7}
crosscorr.plot(out)

```

## Autocorrelation plot

```{r autocorrelation_plot, fig.height=6, fig.width=7}
autocorr.plot(out)
```
Intepretation of the results is done in the main text.

\newpage

# Appendix
`R Code`
```{r eval=FALSE, echo=TRUE}

if (!require(pacman)) install.packages("pacman")
p_load(rjags, coda, nimble, R2OpenBUGS, ggplot2, here, dplyr, ggpubr, tidyr)

projdata <- as.data.frame(read.csv(here("data/projectdata.txt")))|>
  mutate(less_133pc = ifelse(Poverty == "<133% FPL", 1,0),
         btn133_400_pc = ifelse(Poverty == "133% to <400% FPL", 1,0),
         great_400pc = ifelse(Poverty == ">400% FPL", 1,0))
# Data prep for bugs
model_data <- list(
  Y = projdata$Vaccinated,
  N = projdata$Sample.Size,
  btn133_400_pc = projdata$btn133_400_pc,
  great_400pc = projdata$great_400pc,
  J = nrow(projdata)
)

model_inits <- list(
  list(beta0 = 0, beta1 = 0, beta2 = 0)
)

parameters <- c("beta0", "beta1", "beta2")

model1 <- function(){
  for (i in 1:J){
    Y[i] ~ dbin(p[i], N[i])
    logit(p[i]) <- beta0 + beta1*btn133_400_pc[i] + beta2*great_400pc[i]
  }
  #priors
  beta0 ~ dnorm(0, 0.001)
  beta1 ~ dnorm(0, 0.001)
  beta2 ~ dnorm(0, 0.001)
}

# Write model to file
write.model(model1, here("models/model1code.txt"))
# View file
file.show(here("models/model1code.txt"))

model.out <- bugs(model_data, model_inits, 
                  parameters = parameters, model.file = here("models/model1code.txt"),
                  n.chains = 1, n.iter = 10000, n.burnin = 5000, codaPkg = TRUE, 
                  debug = FALSE)

# debug=TRUE opens openBug and displays traceplots and summaries

# Model output
out <- read.bugs(model.out)
summary(out)

# Prep data for density and trace plots
mcmc_samples <- as.mcmc(out)
mcmc_df <- as.data.frame(mcmc_samples)
mcmc_df$iteration <- 1:nrow(mcmc_df)
mcmc_long <- pivot_longer(mcmc_df, cols = -iteration, names_to = "Parameter",
                          values_to = "Value")

points_data <- data.frame(x = mcmc_df$beta0, x1 = mcmc_df$beta1,x2 = mcmc_df$beta2,
                          x3 = mcmc_df$deviance,y = rep(0, nrow(mcmc_df)))

# Density plots
ggarrange(p_beta0 <- ggplot(mcmc_df, aes(x = beta0)) +
            geom_density(fill = "blue", alpha = 0.1) +
            geom_point(data = points_data, aes(x = x, y = y)) +
            labs(title = "Posterior Distribution of beta0", x = "beta0", y = "Density")+
            theme_bw(base_size = 12)+
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),
          
          p_beta1 <- ggplot(mcmc_df, aes(x = beta1)) +
            geom_density(fill = "green", alpha = 0.1) +
            geom_point(data = points_data, aes(x = x1, y = y)) +
            labs(title = "Posterior Distribution of beta1", x = "beta1", y = "Density") +
            theme_bw(base_size = 12)+
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),
          
          p_beta2 <- ggplot(mcmc_df, aes(x = beta2)) +
            geom_density(fill = "red", alpha = 0.1) +
            geom_point(data = points_data, aes(x = x2, y = y)) +
            labs(title = "Posterior Distribution of beta2", x = "beta2", y = "Density")+
            theme_bw(base_size = 12)+
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()),
          
          p_dev <- ggplot(mcmc_df, aes(x = deviance)) +
            geom_density(fill = "yellow", alpha = 0.1) +
            geom_point(data = points_data, aes(x = x3, y = y)) +
            labs(title = "Posterior Distribution of deviance", x = "Deviance", y = "Density")+
            theme_bw(base_size = 12)+
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()), 
          nrow = 2, ncol = 2)

# Trace plots
ggplot(mcmc_long, aes(x = iteration, y = Value, color = Parameter)) +
  geom_line() +
  scale_color_manual(values = c("blue", "green", "red", "yellow")) +
  facet_wrap(~ Parameter, scales = "free_y") +
  labs(title = "Trace Plots of MCMC Samples", x = "Iteration", y = "Parameter Value") +
  theme_bw(base_size = 12)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none")

# Autocorrelation and crosscorrelation plots
crosscorr.plot(out)
autocorr.plot(out)

```

